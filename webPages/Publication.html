<!--Page où apparaissent les publications; Reste à améliorer le style et la mise en page mais opérationnel-->

<!--Connecte à base de données + gère affiche des articles-->
<?php
session_start();
$bdd = new PDO("mysql:host=127.0.0.1;dbname=articles;charset=utf8", "root", "");
$bdd2 = new PDO("mysql:host=127.0.0.1;dbname=espace_membre;charset=utf8", "root", "");
include('filtre.php');

if(isset($_GET['id']) AND !empty($_GET['id'])) {
    $get_id = htmlspecialchars($_GET['id']);
    $article = $bdd->prepare('SELECT * FROM articles WHERE id = ?');
    $article->execute(array($get_id));


    if($article->rowCount() == 1) {
        $article = $article->fetch();
        $id = $article['id'];
        $titre = $article['titre'];
        $contenu = $article['contenu'];

        $likes = $bdd->prepare('SELECT id FROM likes WHERE id_article = ?');
        $likes->execute(array($id));
        $likes = $likes->rowCount();

        $dislikes = $bdd->prepare('SELECT id FROM dislikes WHERE id_article = ?');
        $dislikes->execute(array($id));
        $dislikes = $dislikes->rowCount();

    } else {
        die('Cette article n\'existe pas !!!');
    }

    if(!empty($_SESSION)) {
        if(isset($_POST['submit_commentaire'])) {
            if(isset($_POST['commentaire']) AND !empty($_POST['commentaire'])) {
                $pseudo = htmlspecialchars($_SESSION['pseudo']);
                $commentaire = htmlspecialchars($_POST['commentaire']);
                $ins = $bdd->prepare("INSERT INTO commentaires (pseudo, commentaire, id_article) VALUES (?, ?, ?)");
                $ins->execute(array($pseudo, $commentaire, $get_id));
                $msg = "Votre commentaire a été posté.";
                $lastcom = $commentaire;
                header("Location: Publication.html?id=".$get_id);
            } else {
                $msg = "Le champ est vide, remplissez le pour poster votre commentaire";
            }
        }
    } else {
        $msg = "Vous n'êtes pas membre, vous ne pouvez pas poster de commentaires, inscrivez-vous !!!";
    }

} else {
    die('Erreur');
}


$commentaires = $bdd->prepare("SELECT * FROM commentaires WHERE id_article = ? ORDER BY id DESC");
$commentaires->execute(array($get_id));

?>

    <!DOCTYPE html>
    <html>

    <head>
        <!--Pour mettre des commentaires dans le code, respecter ma syntaxe-->
        <meta charset="UTF-8">
        <!-- Paramètre d'affichage mobile -->
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
        <!-- Gestion du navigateur IE -->
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Publication</title>
        <!--Appliquer le style css et importer l'icone-->
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="style.css" />
        <link rel="icon" href="assets/Inflow_logo_64px.png" />
        <script src="jquery-3.6.0.min.js"></script>
        <script type="text/javascript" src="script.js"></script>
    </head>



    <body>
        <div class="main container">
            <!--Header, c'est-à-dire, le menu pour changer de page-->
            <header class="header container">
                <img class="banniere element" src="assets/banniere_twi.png" />
                <nav class="navBarHeader container element">
                    <div class="headerFirstElement element navBarHeaderElement"><a href="main.html">Menu</a></div>
                    <div class="headerFirstElement element navBarHeaderElement dropdown ">
                        <a href="#">Article</a>
                        <div class="dropdown-content">
                            <div class="navBarHeaderElement"><a href="Article.html" class="selected">Article</a></div>
                            <?php if(isset($_SESSION['confirmer']) AND $_SESSION['confirmer'] == 1 AND isset($_SESSION)) { ?>
                            <div class="navBarHeaderElement">
                                <a href="Poster.html">Poster</a>
                            </div>
                            <?php } ?>
                        </div>
                    </div>
                    <div class="headerFirstElement element navBarHeaderElement"><a href="Playlist.html">Playlist</a></div>
                    <div class="headerFirstElement element navBarHeaderElement dropdown "><a href="#">Espace Membre</a>
                        <div class="dropdown-content">
                            <?php if(empty($_SESSION)) { ?>
                            <div class="navBarHeaderElement"><a href="Inscription.html">Inscription</a></div>
                            <?php } ?>
                            <?php if(empty($_SESSION)) { ?>
                            <div class="navBarHeaderElement">
                                <a href="Connexion.html">Connexion</a></div>
                            <?php } ?>
                            <?php if(!empty($_SESSION)) { ?>
                            <div class="navBarHeaderElement">
                                <a href="Profil.html?id=<?= $_SESSION['id'] ?>">Profil</a></div>
                            <?php } ?>
                            <?php if(isset($_SESSION['admin']) AND $_SESSION['admin'] == 1 AND isset($_SESSION)) { ?>
                            <div class="navBarHeaderElement">
                                <a href="Admin.html">Admin</a>
                            </div>
                            <?php } ?>
                        </div>
                    </div>
                    <div class="headerFirstElement element navBarHeaderElement"><a href="Infos.html" id="Infos">Infos</a></div>
                    <div class="element search">
                        <form action="#">
                            <input type="text" placeholder="Recherche" name="search">
                        </form>
                    </div>
                </nav>
            </header>

            <div class="left">
                <div class="navElement"><a href="Rap.html">Rap</a></div>
                <div class="navElement"><a href="MusiqueUrbaine.html">Musique Urbaine</a></div>
                <div class="navElement"><a href="ChroniquesJason.html">Les Chroniques de Jason</a></div>
            </div>
            
            <!--Début de là où on pourra mettre du texte-->
            <div class="middle">
                <article>

                    <!--Affiche les articles-->
                    <h1>
                        <?= $titre ?>
                    </h1>
                    <p>
                        <?= $contenu ?>
                    </p>
                    <a href="Action.html?t=1&id=<?= $id ?>">Like</a> (
                    <?= $likes ?>)
                    <a href="Action.html?t=2&id=<?= $id ?>">Dislike</a> (
                    <?= $dislikes ?>)

                </article>
            </div>

            <div class="right">
                <br/><br/>
                <div class="Commentaires">
                    <h2>Commentaires :</h2>
                    <form method="POST">
                        <textarea name="commentaire" placeholder="Votre commentaire"></textarea> <br/>
                        <input type="submit" value="Poster" name="submit_commentaire" />
                    </form>
                    <br/>
                    <?php if(isset($msg)) { echo $msg; } ?>
                    <br/>
                    <?php while($c = $commentaires->fetch()) {
                    $pseudoAvatar = $bdd2->prepare("SELECT * FROM membres WHERE pseudo = ? ORDER BY id DESC");
                    $pseudoAvatar->execute(array($c['pseudo']));
                    $avatarInfos = $pseudoAvatar->fetch(); ?>
                    <?php if(!empty($avatarInfos)) { ?>
                    <img src="membres/avatars/<?php echo $avatarInfos['avatar']; ?>" width="50">
                    <?php } ?>
                    <b><?= $c['pseudo'] ?> :</b>
                    <?php $c['commentaire'] = Filtre($c['commentaire']); ?>
                    <?= $c['commentaire'] ?> <br/>
                        <?php } ?>
                </div>
            </div>

            <!--Tout en bas de la page web, contient des infos-->
            <footer class="footer container">
                <div style="flex:0.9;"><p class="element"> Articles et actus sur le rap - <i>Axelito à l'origine</i> - <a href="https://discord.com/channels/826440352810139678/826491405856800788">Rejoignez le Discord !</a></p></div>
                <div class="BoutonTransition"><input id="darkTrigger" type="checkbox" class="BoutonTransition"></div>
            </footer>
        </div>
    </body>

    </html>